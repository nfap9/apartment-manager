# 公寓管理系统 后端数据库表结构设计

## 概览

- 技术栈：PostgreSQL + Prisma ORM（TypeScript）
- 数据源位置：[schema.prisma](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/prisma/schema.prisma)
- 迁移脚本：apps/api/prisma/migrations 下的 migration.sql
- 设计原则：
  - 多组织隔离：核心实体均关联 Organization
  - RBAC 权限：Role/Permission/Membership 组合
  - 账单周期化：Invoice 与 InvoiceItem 支持固定/按量计费
  - 公寓/房间结构化：Apartment、Room、设施与定价

## 枚举定义

- MembershipStatus：PENDING | ACTIVE | DISABLED
- RentIncreaseType：NONE | FIXED | PERCENT
- FeeMode：FIXED | METERED
- FeeType：WATER | ELECTRICITY | MANAGEMENT | INTERNET | GAS | OTHER
- LeaseStatus：DRAFT | ACTIVE | ENDED | TERMINATED
- InvoiceStatus：DRAFT | ISSUED | PAID | VOID | OVERDUE
- InvoiceItemKind：RENT | DEPOSIT | CHARGE
- InvoiceItemStatus：PENDING_READING | CONFIRMED
- NotificationType：INVOICE_CREATED | LEASE_EXPIRING | SYSTEM

## 表结构总览

- 用户与组织
  - User：用户
  - Organization：组织
  - Membership：用户加入组织的关系（含状态）
  - Role / Permission / RolePermission / MembershipRole：RBAC
  - OrgInvite / OrgInviteUse：组织邀请与使用记录
  - AuditLog：审计日志
  - Notification：站内通知
- 公寓与房间
  - Apartment：公寓
  - ApartmentUpstream：上游成本与租金信息
  - ApartmentFeePricing：公寓费用定价模板
  - Room：房间
  - RoomFacility：房间设施
  - RoomPricingPlan：房间价格方案
- 租客与租约、账单
  - Tenant：租客
  - Lease：租约（含租金递增、计费周期等参数）
  - LeaseCharge：租约费用项（固定/按量）
  - Invoice：账单（周期）
  - InvoiceItem：账单明细（房租、费用、押金）

## 关键表详情

### User
- 主键：id UUID
- 字段：phone 唯一、passwordHash、displayName、tokenVersion
- 关联：Membership、Notification、OrgInvite.createdBy、OrgInviteUse、AuditLog.actor
- 索引：phone 唯一

### Organization
- 主键：id UUID
- 字段：name
- 关联：Membership、Role、OrgInvite、Apartment、Tenant、Lease、Invoice、Notification、AuditLog

### Membership
- 复合唯一：userId + organizationId
- 字段：status（枚举）
- 外键：userId -> User、organizationId -> Organization
- 关联：MembershipRole
- 索引：organizationId、userId

### Role / Permission / RolePermission / MembershipRole
- Role：组织内的角色（name 在组织内唯一；isSystem 系统角色）
- Permission：权限定义（key 唯一）
- RolePermission：复合主键 roleId + permissionId
- MembershipRole：复合主键 membershipId + roleId
- 索引：常规外键索引

### OrgInvite / OrgInviteUse
- OrgInvite：邀请码（code 唯一、expiresAt、maxUses、usedCount）
- OrgInviteUse：复合唯一 inviteId + userId
- 外键：createdByUserId -> User（Restrict）；其余级联

### Apartment
- 外键：organizationId -> Organization
- 唯一/索引：organizationId 索引
- 关联：ApartmentUpstream（1:1）、Room（1:N）、ApartmentFeePricing（1:N）
- 字段：name、address、totalArea、floor

### ApartmentUpstream
- 主键：apartmentId（与 Apartment 1:1）
- 字段：转/装/押/其他一次性费用；上游租金与递增设置；notes
- 索引：无（主键即索引）

### ApartmentFeePricing
- 唯一：apartmentId + feeType
- 字段：feeType（枚举）、mode（枚举）、fixedAmountCents、unitPriceCents、unitName
- 外键：apartmentId -> Apartment
- 索引：apartmentId

### Room
- 唯一：apartmentId + name
- 字段：layout、area、notes、isActive、isRented
- 外键：apartmentId -> Apartment
- 关联：RoomFacility、RoomPricingPlan、Lease
- 索引：apartmentId

### RoomFacility
- 唯一：roomId + name
- 字段：quantity（默认1）、valueCents（默认0）
- 外键：roomId -> Room
- 索引：roomId

### RoomPricingPlan
- 唯一：roomId + durationMonths
- 字段：rentCents、depositCents、isActive
- 外键：roomId -> Room
- 索引：roomId

### Tenant
- 外键：organizationId -> Organization
- 字段：name、phone（索引）、idNumber
- 索引：organizationId、phone

### Lease
- 外键：organizationId -> Organization；roomId -> Room（Restrict）；tenantId -> Tenant（Restrict）
- 字段：status、startDate、endDate、billingCycleMonths、depositCents、baseRentCents、rentIncrease*
- 关联：LeaseCharge、Invoice
- 索引：organizationId、roomId、tenantId

### LeaseCharge
- 外键：leaseId -> Lease
- 字段：name、feeType?、mode、fixedAmountCents?、unitPriceCents?、unitName?、billingCycleMonths、isActive
- 关联：InvoiceItem
- 索引：leaseId

### Invoice
- 复合唯一：leaseId + periodStart + periodEnd
- 外键：organizationId -> Organization；leaseId -> Lease
- 字段：status、periodStart/End、dueDate、totalAmountCents、issuedAt、paidAt?
- 关联：InvoiceItem
- 索引：organizationId、leaseId、status

### InvoiceItem
- 外键：invoiceId -> Invoice；leaseChargeId? -> LeaseCharge（SetNull）
- 字段：name、kind、mode?、status、金额/单价/单位/数量、表计读数
- 索引：invoiceId、leaseChargeId、status

### Notification
- 外键：organizationId -> Organization；userId -> User
- 字段：type、title、body、entityType/Id?、readAt?
- 索引：organizationId、userId、readAt

### AuditLog
- 外键：organizationId -> Organization；actorUserId? -> User（SetNull）
- 字段：action、entityType/Id?、metadata?
- 索引：organizationId、actorUserId

## 关系与约束摘要

- 组织隔离：除 Permission/Role 定义外，业务数据均通过 organizationId 隔离
- 房间唯一：同一公寓下房间 name 唯一
- 账单唯一：同一租约的账期（periodStart, periodEnd）唯一
- RBAC：角色-权限、成员-角色通过关联表实现，删除采用级联/保留策略
- 租约冲突：业务层在创建/更新租约时校验时间重叠，保证房间出租状态一致

## 迁移与生成

- 迁移目录：[migrations](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/prisma/migrations)
- Prisma Client 生成目录：[generated/prisma](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/prisma/generated/prisma)

