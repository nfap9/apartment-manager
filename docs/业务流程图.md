# 公寓管理系统 - 业务流程图

## 目录
1. [系统整体架构](#系统整体架构)
2. [用户与组织管理流程](#用户与组织管理流程)
3. [公寓与房间管理流程](#公寓与房间管理流程)
4. [签约流程](#签约流程)
5. [账单生成与管理流程](#账单生成与管理流程)
6. [租约管理流程](#租约管理流程)
7. [核心业务实体关系](#核心业务实体关系)

---

## 系统整体架构

```mermaid
graph TB
    A[用户注册/登录] --> B[加入组织]
    B --> C[创建/管理公寓]
    C --> D[创建/管理房间]
    D --> E[配置房间定价]
    E --> F[签约流程]
    F --> G[创建租约]
    G --> H[自动生成账单]
    H --> I[确认读数]
    I --> J[确认账单]
    J --> K[标记支付]
    K --> L[租约管理]
    L --> M[租约终止]
    M --> D
```

---

## 用户与组织管理流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant A as 认证系统
    participant O as 组织系统
    participant P as 权限系统

    U->>A: 注册/登录
    A->>A: 验证凭证
    A->>U: 返回AccessToken
    
    U->>O: 创建组织
    O->>O: 创建组织记录
    O->>O: 创建Admin角色
    O->>O: 分配所有权限给Admin
    O->>O: 绑定创建者为Admin
    O->>U: 返回组织信息
    
    U->>O: 创建邀请码
    O->>O: 生成邀请码
    O->>U: 返回邀请码
    
    U->>O: 接受邀请码
    O->>O: 验证邀请码
    O->>O: 创建成员关系
    O->>P: 分配角色权限
    O->>U: 返回成员信息
```

---

## 公寓与房间管理流程

```mermaid
flowchart TD
    A[创建公寓] --> B[配置公寓基本信息]
    B --> C{是否配置上游费用?}
    C -->|是| D[配置上游费用<br/>转让费/装修费/押金等]
    C -->|否| E[配置公寓费用模板]
    D --> E
    E --> F[创建房间]
    F --> G{批量导入?}
    G -->|是| H[下载Excel模板]
    H --> I[填写房间信息]
    I --> J[上传Excel文件]
    J --> K{存在重复房间?}
    K -->|是| L[选择处理策略<br/>跳过/覆盖/取消]
    K -->|否| M[批量创建房间]
    L --> M
    G -->|否| N[手动创建房间]
    N --> O[配置房间设施]
    O --> P[配置房间定价计划]
    M --> O
    P --> Q[房间管理完成]
```

### 房间状态管理

```mermaid
stateDiagram-v2
    [*] --> 未启用: 创建房间(isActive=false)
    未启用 --> 空闲: 启用房间(isActive=true)
    空闲 --> 已租出: 创建租约(isRented=true)
    已租出 --> 空闲: 租约终止/无活跃租约
    空闲 --> 未启用: 停用房间
    已租出 --> 未启用: 停用房间(需先终止租约)
```

---

## 签约流程

```mermaid
flowchart TD
    A[开始签约] --> B[获取可租房间列表]
    B --> C[选择房间]
    C --> D{租客是否存在?}
    D -->|是| E[选择已有租客]
    D -->|否| F[创建新租客]
    F --> G[填写租客信息<br/>姓名/电话/身份证]
    E --> H[获取公寓费用模板]
    G --> H
    H --> I[配置租约信息]
    I --> J[填写租期<br/>开始日期/结束日期]
    J --> K[填写租金信息<br/>基础租金/押金]
    K --> L[配置租金递增<br/>固定/百分比/无]
    L --> M[配置费用项]
    M --> N{费用类型}
    N -->|固定费用| O[设置固定金额]
    N -->|按量计费| P[设置单价/单位]
    O --> Q[检查租期冲突]
    P --> Q
    Q --> R{是否存在冲突?}
    R -->|是| S[返回错误]
    R -->|否| T[创建租约]
    T --> U[创建费用项]
    U --> V[更新房间状态为已租出]
    V --> W[签约完成]
    S --> I
```

### 签约事务处理

```mermaid
sequenceDiagram
    participant U as 用户
    participant S as 签约服务
    participant DB as 数据库

    U->>S: 提交签约信息
    S->>DB: 开始事务
    S->>DB: 检查房间状态
    alt 房间不可租
        DB-->>S: 返回错误
        S-->>U: 房间已租出/已停用
    else 房间可租
        S->>DB: 检查租期冲突
        alt 存在冲突
            DB-->>S: 返回冲突信息
            S-->>U: 租期冲突错误
        else 无冲突
            alt 需要创建新租客
                S->>DB: 创建租客记录
            end
            S->>DB: 创建租约记录
            S->>DB: 创建费用项记录
            S->>DB: 更新房间isRented=true
            S->>DB: 提交事务
            DB-->>S: 成功
            S-->>U: 返回租约信息
        end
    end
```

---

## 账单生成与管理流程

```mermaid
flowchart TD
    A[触发账单生成] --> B[查询所有活跃租约]
    B --> C[遍历每个租约]
    C --> D[获取租约最后账单]
    D --> E{是否有最后账单?}
    E -->|是| F[计算下个账期开始时间]
    E -->|否| G[使用租约开始日期]
    F --> H[计算账期结束时间]
    G --> H
    H --> I{账期是否到期?}
    I -->|否| J[跳过该租约]
    I -->|是| K[计算租金<br/>考虑递增规则]
    K --> L[筛选需要计费的费用项]
    L --> M{费用类型}
    M -->|固定费用| N[计算固定费用金额]
    M -->|按量计费| O[创建待确认读数项]
    N --> P[创建账单]
    O --> P
    P --> Q[创建账单明细项]
    Q --> R[计算账单总额]
    R --> S[发送通知给账单管理员]
    S --> T{还有更多账期?}
    T -->|是| F
    T -->|否| U[账单生成完成]
    J --> T
```

### 账单确认与支付流程

```mermaid
sequenceDiagram
    participant M as 账单管理员
    participant B as 账单系统
    participant DB as 数据库

    Note over B: 账单已生成(状态: ISSUED)
    M->>B: 查看账单详情
    B->>DB: 查询账单及明细
    DB-->>B: 返回账单信息
    B-->>M: 显示账单
    
    alt 存在待确认读数项
        M->>B: 确认读数
        B->>DB: 更新读数项<br/>meterStart/meterEnd
        B->>DB: 计算用量和金额
        B->>DB: 更新账单总额
        DB-->>B: 更新成功
        B-->>M: 读数确认成功
    end
    
    M->>B: 确认账单
    B->>DB: 检查所有读数是否已确认
    alt 存在未确认读数
        DB-->>B: 返回错误
        B-->>M: 存在待确认读数
    else 所有读数已确认
        B->>DB: 更新账单状态为ISSUED
        DB-->>B: 更新成功
        B-->>M: 账单确认成功
    end
    
    M->>B: 标记为已支付
    B->>DB: 更新账单状态为PAID
    B->>DB: 记录支付时间
    DB-->>B: 更新成功
    B-->>M: 支付标记成功
```

### 账单状态流转

```mermaid
stateDiagram-v2
    [*] --> DRAFT: 手动创建账单
    [*] --> ISSUED: 自动生成账单
    
    DRAFT --> ISSUED: 确认账单<br/>所有读数已确认
    ISSUED --> PAID: 标记为已支付
    ISSUED --> OVERDUE: 超过到期日期
    ISSUED --> VOID: 作废账单
    PAID --> [*]
    OVERDUE --> PAID: 标记为已支付
    VOID --> [*]
```

### 账单明细项状态

```mermaid
stateDiagram-v2
    [*] --> CONFIRMED: 固定费用项/房租
    [*] --> PENDING_READING: 按量计费项
    
    PENDING_READING --> CONFIRMED: 确认读数<br/>填写meterStart/meterEnd
    CONFIRMED --> [*]
```

---

## 租约管理流程

```mermaid
flowchart TD
    A[查看租约列表] --> B[筛选租约]
    B --> C{操作类型}
    C -->|查看详情| D[显示租约信息<br/>房间/租客/费用项]
    C -->|更新租约| E[修改租约信息]
    E --> F{修改内容}
    F -->|修改结束日期| G[检查新日期是否冲突]
    F -->|修改状态| H[更新租约状态]
    F -->|修改备注| I[更新备注]
    G --> J{是否存在冲突?}
    J -->|是| K[返回错误]
    J -->|否| H
    H --> L[检查房间活跃租约]
    L --> M{房间是否有<br/>ACTIVE/DRAFT租约?}
    M -->|是| N[保持房间isRented=true]
    M -->|否| O[设置房间isRented=false]
    N --> P[更新完成]
    O --> P
    I --> P
    K --> E
    C -->|终止租约| Q[设置状态为TERMINATED]
    Q --> L
```

### 租约状态流转

```mermaid
stateDiagram-v2
    [*] --> DRAFT: 创建租约(可选)
    DRAFT --> ACTIVE: 激活租约
    [*] --> ACTIVE: 直接创建活跃租约
    
    ACTIVE --> ENDED: 租期结束
    ACTIVE --> TERMINATED: 提前终止
    ENDED --> TERMINATED: 正式终止
    TERMINATED --> [*]
    
    note right of ACTIVE
        活跃租约会参与
        账单自动生成
    end note
```

---

## 核心业务实体关系

```mermaid
erDiagram
    Organization ||--o{ Apartment : "拥有"
    Organization ||--o{ Tenant : "拥有"
    Organization ||--o{ Lease : "拥有"
    Organization ||--o{ Invoice : "拥有"
    
    Apartment ||--o{ Room : "包含"
    Apartment ||--o{ ApartmentFeePricing : "配置"
    Apartment ||--|| ApartmentUpstream : "上游费用"
    
    Room ||--o{ RoomFacility : "设施"
    Room ||--o{ RoomPricingPlan : "定价计划"
    Room ||--o{ Lease : "租赁"
    
    Tenant ||--o{ Lease : "签约"
    
    Lease ||--o{ LeaseCharge : "费用项"
    Lease ||--o{ Invoice : "生成账单"
    
    Invoice ||--o{ InvoiceItem : "明细项"
    InvoiceItem }o--|| LeaseCharge : "关联费用项"
    
    User ||--o{ Membership : "成员关系"
    Membership }o--|| Organization : "所属组织"
    Membership ||--o{ MembershipRole : "角色"
    MembershipRole }o--|| Role : "角色定义"
    Role ||--o{ RolePermission : "权限"
    RolePermission }o--|| Permission : "权限定义"
```

---

## 关键业务规则说明

### 1. 租约冲突检查
- 只有**未终止(非TERMINATED状态)**的租约才会阻止创建新租约
- 检查条件：`startDate < newEndDate AND endDate > newStartDate`
- 已终止的租约不影响新租约创建

### 2. 房间状态同步
- 创建租约时：自动设置 `room.isRented = true`
- 更新租约时：根据房间是否存在 `ACTIVE` 或 `DRAFT` 租约自动同步 `isRented` 状态
- 如果房间没有任何活跃租约，则 `isRented = false`

### 3. 账单生成规则
- 只对 `ACTIVE` 状态的租约生成账单
- 从租约开始日期或最后账单的结束日期开始计算
- 最多追赶24个账期，避免无限循环
- 账单账期 = `billingCycleMonths`（默认1个月）

### 4. 租金递增计算
- **NONE**: 不递增，始终使用基础租金
- **FIXED**: 每 `rentIncreaseIntervalMonths` 个月增加固定金额 `rentIncreaseValue`
- **PERCENT**: 每 `rentIncreaseIntervalMonths` 个月按百分比递增 `rentIncreaseValue%`

### 5. 费用计费规则
- **固定费用(FIXED)**: 直接使用 `fixedAmountCents`
- **按量计费(METERED)**: 需要确认读数，计算 `(meterEnd - meterStart) * unitPriceCents`
- **计费周期**: 根据 `billingCycleMonths` 决定是否在当期计费
- **计费时机**: 
  - 水电费默认后付(POSTPAID)，账期是上个月
  - 其他费用默认预付(PREPAID)，账期是下个月

### 6. 账单确认流程
- 账单生成时，按量计费项状态为 `PENDING_READING`
- 必须先确认所有待确认读数项，才能确认账单
- 确认读数时自动计算金额并更新账单总额
- 账单确认后状态从 `DRAFT` 变为 `ISSUED`

### 7. 通知机制
- 账单生成时，自动通知有 `billing.manage` 权限的成员
- 通知类型：`INVOICE_CREATED`
- 通知包含账单账期和账单ID

---

## 数据流转示例

### 完整业务流程示例

```
1. 用户注册 → 创建组织 → 获得Admin权限
2. 创建公寓 → 配置费用模板(水费/电费/物业费等)
3. 创建房间 → 配置房间设施 → 配置定价计划
4. 签约流程：
   - 选择房间(自动过滤已租出房间)
   - 创建/选择租客
   - 配置租约信息(租期/租金/费用项)
   - 系统检查租期冲突
   - 创建租约 → 房间状态变为已租出
5. 账单生成(定时任务或手动触发)：
   - 查询所有ACTIVE租约
   - 计算每个租约的下个账期
   - 生成账单(房租+固定费用+待确认读数项)
   - 发送通知给账单管理员
6. 账单管理：
   - 查看账单列表
   - 确认按量计费项的读数
   - 确认账单(所有读数已确认)
   - 标记为已支付
7. 租约管理：
   - 查看租约详情
   - 更新租约信息(结束日期/状态/备注)
   - 终止租约 → 房间状态自动更新
```

---

## 权限控制说明

系统采用基于角色的访问控制(RBAC)：

- **组织级别**: 用户必须属于组织才能访问组织资源
- **权限级别**: 每个操作需要特定权限，如：
  - `apartment.read/write`: 公寓管理
  - `room.read/write`: 房间管理
  - `lease.read/write`: 租约管理
  - `billing.read/manage`: 账单管理
  - `tenant.read/write`: 租客管理
  - `org.manage/role.manage/member.manage`: 组织管理

- **系统角色**: Admin角色自动拥有所有权限，且不能移除 `org.manage` 和 `org.role.manage` 权限

---

*文档生成时间: 2025-02-04*
*系统版本: 基于 Prisma + Express + TypeScript*
