# 公寓管理系统 后端接口文档

## 概览

- 技术栈：Express + TypeScript + Prisma
- 基础路由前缀：支持两种前缀
  - 无前缀（例如 /auth/login）
  - /api 前缀（例如 /api/auth/login）
- 路由汇总位置：[router.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/router.ts)
- OpenAPI 概述：[openapi.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/openapi.ts)；在线文档路由：/docs

## 认证与权限

- 认证方式：HTTP Bearer JWT（Authorization: Bearer <token>）
  - AccessToken 在响应体返回；RefreshToken 以 httpOnly Cookie 存储
  - 刷新接口会读取 Cookie 中的 RefreshToken
  - 认证中间件：[requireAuth](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/middleware/requireAuth.ts)
- 组织成员与权限
  - 组织成员校验：[requireOrgMember](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/middleware/requireOrgMember.ts)
  - 细粒度权限校验：[requirePermission](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/middleware/requirePermission.ts)
  - 权限键集合：[permissionKeys.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/rbac/permissionKeys.ts)

## 错误响应格式

- 校验错误（Zod）：HTTP 400
  - { error: { code: 'VALIDATION_ERROR', message, details } }
- 业务错误（HttpError）：HTTP 对应状态码
  - { error: { code, message, details? } }
- 服务端错误：HTTP 500
  - { error: { code: 'INTERNAL_SERVER_ERROR', message, details? } }
- 统一处理中间件：[errorMiddleware.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/http/errorMiddleware.ts)

## 公共接口

- GET /health
  - 说明：健康检查
  - 响应：{ ok: true }
- GET /openapi.json
  - 说明：OpenAPI JSON
- GET /docs
  - 说明：Swagger UI 文档页

## 认证模块 [auth.router.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/modules/auth/auth.router.ts)

- POST /auth/register
  - Body：{ phone: string(数字6-20), password: string(8-72), displayName?: string }
  - 响应：{ accessToken, user: { id, phone, displayName } }
  - 错误：PHONE_EXISTS
- POST /auth/login
  - Body：{ phone: string(数字), password: string }
  - 响应：{ accessToken, user }
  - 错误：INVALID_CREDENTIALS
- POST /auth/refresh
  - 读取 Refresh Cookie，返回新的 accessToken
  - 响应：{ accessToken }
- POST /auth/logout（需认证）
  - 动作：提升 tokenVersion、清除 Refresh Cookie
  - 响应：{ ok: true }
- GET /auth/me（需认证）
  - 响应：{ user, organizations: [{ membershipId, organizationId, organizationName }] }

## 组织与权限模块 [org.router.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/modules/org/org.router.ts)

- GET /orgs（需认证）
  - 响应：{ organizations: [{ membershipId, organizationId, organizationName }] }
- GET /orgs/{orgId}/me（需组织成员）
  - 响应：{ organizationId, membershipId, permissionKeys }
- POST /orgs（需认证）
  - Body：{ name: string(1-100) }
  - 动作：创建组织、系统 Admin 角色、赋权并绑定创建者
  - 响应：{ organization: { id, name }, membershipId }
- POST /orgs/{orgId}/invites（org.invite）
  - Body：{ maxUses?: int+, expiresInDays?: int+(≤365) }
  - 响应：{ invite: { code, expiresAt?, maxUses?, usedCount, createdAt } }
- POST /orgs/{orgId}/invites/accept（需认证）
  - Body：{ code: string }
  - 响应：{ membershipId, organizationId }
- GET /orgs/{orgId}/permissions（org.role.manage）
  - 响应：{ permissions: [{ id, key, description }] }
- GET /orgs/{orgId}/roles（org.role.manage）
  - 响应：{ roles }
- POST /orgs/{orgId}/roles（org.role.manage）
  - Body：{ name: string(1-50), description?: string(≤200) }
  - 错误：ROLE_EXISTS
- GET /orgs/{orgId}/roles/{roleId}/permissions（org.role.manage）
  - 响应：{ permissionKeys: string[] }
- PUT /orgs/{orgId}/roles/{roleId}/permissions（org.role.manage）
  - Body：{ permissionKeys: string[] (≤500) }
  - 说明：Admin 系统角色强制包含 org.manage 与 org.role.manage
  - 响应：{ ok: true }
- GET /orgs/{orgId}/members（org.member.manage）
  - 响应：{ members: [{ membershipId, user: { id, phone, displayName }, roles: [{ id, name }] }] }
- PUT /orgs/{orgId}/members/{memberId}/roles（org.member.manage）
  - Body：{ roleIds: string[] (≤50) }
  - 响应：{ ok: true }

## 公寓与房间模块 [apartment.router.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/modules/apartment/apartment.router.ts)

- GET /orgs/{orgId}/apartments（apartment.read）
  - 响应：{ apartments }
- POST /orgs/{orgId}/apartments（apartment.write）
  - Body：{ name, address, totalArea?, floor? }
  - 响应：{ apartment }
- GET /orgs/{orgId}/apartments/{apartmentId}（apartment.read）
  - 响应：{ apartment(include rooms+facilities) }
- PUT /orgs/{orgId}/apartments/{apartmentId}（apartment.write）
  - Body：同创建的部分更新
  - 响应：{ apartment }
- GET /orgs/{orgId}/apartments/{apartmentId}/upstream（apartment.upstream.read）
  - 响应：{ upstream }
- PUT /orgs/{orgId}/apartments/{apartmentId}/upstream（apartment.upstream.write）
  - Body：上游费用与租金递增参数
  - 响应：{ upstream }
- GET /orgs/{orgId}/apartments/{apartmentId}/fee-pricings（apartment.read）
  - 响应：{ feePricings }
- PUT /orgs/{orgId}/apartments/{apartmentId}/fee-pricings（apartment.write）
  - Body：[{ feeType, mode, fixedAmountCents?, unitPriceCents?, unitName? }] (≤50)
  - 校验：FIXED 需 fixedAmountCents；METERED 需 unitPriceCents
  - 响应：{ feePricings }
- GET /orgs/{orgId}/apartments/{apartmentId}/rooms（room.read）
  - 响应：{ rooms(include pricingPlans+facilities) }
- POST /orgs/{orgId}/apartments/{apartmentId}/rooms（room.write）
  - Body：{ name, layout?, area?, notes?, isActive?, isRented?, facilities?[] }
  - 响应：{ room(include facilities) }
- GET /orgs/{orgId}/apartments/{apartmentId}/rooms/import-template（room.write）
  - 说明：下载房间批量导入 Excel 模板（含“使用说明/房间/设施”三个 Sheet）
- POST /orgs/{orgId}/apartments/{apartmentId}/rooms/import（room.write）
  - FormData：file=Excel(.xlsx)
  - Query：duplicateStrategy=skip|overwrite|cancel（可选）
  - 响应：
    - 409 DUPLICATE_ROOMS：返回重复房间名列表
    - 成功：返回创建/更新/跳过的统计与明细（参见实现）

## 租客模块 [tenant.router.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/modules/tenant/tenant.router.ts)

- GET /orgs/{orgId}/tenants（tenant.read）
  - Query：q?（按 name/phone 模糊）
  - 响应：{ tenants }
- POST /orgs/{orgId}/tenants（tenant.write）
  - Body：{ name, phone(数字6-20), idNumber? }
  - 响应：{ tenant }；错误：TENANT_CREATE_FAILED
- GET /orgs/{orgId}/tenants/{tenantId}（tenant.read）
  - 响应：{ tenant }
- PUT /orgs/{orgId}/tenants/{tenantId}（tenant.write）
  - Body：同创建的部分更新
  - 响应：{ tenant }

## 租约模块 [lease.router.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/modules/lease/lease.router.ts)

- GET /orgs/{orgId}/leases（lease.read）
  - 响应：{ leases(include room(apartment), tenant, charges) }
- GET /orgs/{orgId}/leases/{leaseId}（lease.read）
  - 响应：{ lease(include room(apartment+pricingPlans), tenant, charges) }
- POST /orgs/{orgId}/leases（lease.write）
  - Body：{ roomId, tenantId, startDate, endDate, baseRentCents, billingCycleMonths?, depositCents?, rentIncrease*, notes?, charges?[] }
  - 校验：时间不重叠；费用项 FIXED/METERED 参数完整
  - 响应：{ lease(include charges) }
- PUT /orgs/{orgId}/leases/{leaseId}（lease.write）
  - Body：{ status?, endDate?, notes? }
  - 逻辑：校验日期、更新房间 isRented 状态与租约重叠
  - 响应：{ lease }

## 账单模块 [billing.router.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/modules/billing/billing.router.ts)

- POST /orgs/{orgId}/billing/run（billing.manage）
  - 动作：按每个租约最近账期生成到期账单（最多追赶 24 周期）
  - 响应：{ createdCount, createdInvoiceIds }
- GET /orgs/{orgId}/invoices（billing.read）
  - Query：status?，leaseId?
  - 响应：{ invoices(include lease(room(apartment), tenant), items) }
- GET /orgs/{orgId}/invoices/{invoiceId}（billing.read）
  - 响应：{ invoice(include lease(room(apartment), tenant, charges), items) }
- POST /orgs/{orgId}/invoices/{invoiceId}/items/{itemId}/confirm-reading（billing.manage）
  - Body：{ meterStart?, meterEnd }
  - 响应：{ ok: true }；同时更新明细与账单总额

## 签约模块（一站式）[signing.router.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/modules/signing/signing.router.ts)

- GET /orgs/{orgId}/signing/available-rooms（lease.write）
  - 响应：{ rooms(include apartment, pricingPlans, facilities) }
- GET /orgs/{orgId}/signing/fee-templates/{apartmentId}（lease.write）
  - 响应：{ charges }（由公寓费率模板转换）
- POST /orgs/{orgId}/signing（lease.write）
  - Body：支持选择现有租客或创建新租客 + 创建租约 + 费用项
  - 响应：{ message: '签约成功', lease(include apartment, tenant, charges), tenant }

## 通知模块 [notification.router.ts](file:///e:/learn_file/cursor_project/apartment-manager/apps/api/src/modules/notification/notification.router.ts)

- GET /orgs/{orgId}/notifications（notification.read）
  - Query：unreadOnly?，limit? ≤200
  - 响应：{ notifications }
- POST /orgs/{orgId}/notifications/{notificationId}/read（notification.read）
  - 动作：标记为已读
  - 响应：{ ok: true }

